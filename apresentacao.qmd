---
title: MÉTODOS DE MACHINE LEARNING PARA RECONCILIAÇÃO ÓTIMA DE SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS DE INSTITUIÇÕES FINANCEIRAS
subtitle: DEFESA DE DISSERTAÇÃO DE MESTRADO
author: Alberson Miranda, PPGEco/UFES
date: '`r format(Sys.Date(), "%B de %Y")`'
format:
    beamer:
        include-in-header: config/beamer/preamble.tex
        include-after-body: config/beamer/backmatter.tex
        keep-tex: false
        latex-max-runs: 4
        number-sections: false
        output-file: apresentacao.pdf
bibliography: config/elementos/dissertacao.bib
cite-method: biblatex
link-citations: true
link-bibliography: true
---

```{r config}
#| include = FALSE

# opções
knitr::opts_chunk$set(
    out.width = "90%"
)

# reprodutibilidade
set.seed(1)

# pacotes
pacman::p_load(
    kableExtra,
    ggplot2,
    tsibble,
    fable,
    fabletools
)

# tema ggplot
tema = theme_classic() +
    theme(
        text = element_text(family = "serif")
    )

# gerar bibliografia de pacotes
knitr::write_bib(
    c(.packages(), "basedosdados")
    , file = "config/elementos/packages.bib"
)

# scripts
source("scripts/estban/hierarq.R")
```

# CONTEXTUALIZAÇÃO DA PESQUISA

## ANÁLISE DE SÉRIES TEMPORAIS EM ECONOMIA BANCÁRIA

- Problemas populares na literatura: risco de crédito, detecção de anomalias (fraude), preços de ativos, alocação ótima de numerários [@sezer_financial_2019]
- Pouco sobre projeção de saldos e rendas (*guidance*, *budgeting*)
- Previsões equivocadas = percepção de incompetência, redução de reputação e receitas [@beccalli_earnings_2015]
- Orçamentação em empresas de muitas filiais: alta dimensionalidade e dúvidas

## ANÁLISE DE SÉRIES TEMPORAIS EM ECONOMIA BANCÁRIA

- Banestes: 134 agências, 78 municípios do ES, 13 microrregiões, 4 mesorregiões
- Qual a melhor forma de realizar projeções?
    - Individualmente por agência?
    - Apenas o total e distribuir proporcionalmente?
    - As informações por mesorregião ou microrregião são importantes?
    - Como usar toda a informação?

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

Séries temporais hierárquicas são aquelas que podem ser agregadas ou desagregadas naturalmente em uma estrutura aninhada [@hyndman_forecasting_2021]

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

![](img/hierarq.png)

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

- Cada nível traz informação diferente
- É razoável supor que exista covariância entre as previsões dos diferentes níveis
- Toda informação da estrutura pode ser útil

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

Séries temporais agrupadas são aquelas que não impõem uma única estrutura hierárquica

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

![](img/agrupadas.png)

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

![](img/hier_agrup.png)

## SÉRIES TEMPORAIS HIERÁRQUICAS E AGRUPADAS

![](img/hier_agrup_2.png)

## COERÊNCIA E RECONCILIAÇÃO

- Coerência: cada nó da hierarquia deve totalizar os nós filhos
- Não há razão para que as previsões individuais (e.g., Arima, ETS) sejam coerentes

### RECONCILIAÇÃO ÓTIMA

Reescrever as previsões de forma que elas sejam coerentes, utilizando toda a informação disponível na estrutura hierárquica, ao mesmo tempo em que minimiza a variância do erro de previsão

# OBJETIVOS

## OBJETIVO GERAL

Estudar o problema da reconciliação ótima de previsões pontuais a partir de métodos de *machine learning* em séries temporais hierárquicas e agrupadas do Banco do Estado do Espírito Santo

## OBJETIVOS ESPECÍFICOS

1. Estender a abordagem de @spiliotis_hierarchical_2021 para a reconciliação ótima de séries temporais hierárquicas *e agrupadas*;
1. Avaliar a efetividade de mais 4 implementaçãoes de métodos de ML (*lasso*, *ridge*, *elastic net*, SVM e *lightGBM*), além dos 2 propostos no trabalho original (*XGBoost* e *random forest*);
1. Propor duas variações metodológicas para obtenção da amostra de treino dos modelos de ML;
1. Obter ganhos de performance no contexto de séries temporais financeiras.

# RECONCILIAÇÃO DE SÉRIES TEMPORAIS HIERÁRQUICAS

## BOTTOM-UP

- informações apenas dos níveis mais desagregados
- soma-se para obter os níveis agregados

## TOP-DOWN

- apenas informações do nível mais agregado
- há dezenas de métodos para distribuir proporcionalmente as previsões agregadas [@gross_disaggregation_1990]
- não podem ser utilizadas no contexto de séries temporais agrupadas^[Desambiguar uma estrutura agrupada resulta em uma estrutura hierárquica, mas há necessariamente perda de informação (e.g., fixar os verbetes abaixo das agências, causaria a perca da informação do agregado dos verbetes).].

## MIDDLE-OUT

- informações apenas de um nível intermediário
- soma-se para obter os níveis agregados e distribui-se proporcionalmente para os níveis mais desagregados

## NOTAÇÃO MATRICIAL

$$
\mathbfit{\tilde{y}_t} = \mathbfit{SG\hat{y}_t}
$$ {#eq-reconciliacao1}

Em que

- $\mathbfit{\tilde{y}_t}$ é o vetor de previsões reconciliadas
- $\mathbfit{S}$ é a matriz de soma
- $\mathbfit{G}$ é a matriz de reconciliação
- $\mathbfit{\hat{y}_t}$ é o vetor de previsões base

## MATRIZ DE SOMA

$\mathbfit{S}$ mapeia a estrutura hierárquica a partir da soma dos elementos mais desagregados

$$
\begin{bmatrix}
    \tilde{y}_{t} \\
    \tilde{y}_{A,t} \\
    \tilde{y}_{B,t} \\
    \tilde{y}_{AA,t} \\
    \tilde{y}_{AB,t} \\
    \tilde{y}_{AC,t} \\
    \tilde{y}_{BA,t} \\
    \tilde{y}_{BB,t}
  \end{bmatrix}_{8 \times 1}
  =
  \begin{bmatrix}
    1 & 1 & 1 & 1 & 1 \\
    1 & 1 & 1 & 0 & 0 \\
    0 & 0 & 0 & 1 & 1 \\
    1  & 0  & 0  & 0  & 0  \\
    0  & 1  & 0  & 0  & 0  \\
    0  & 0  & 1  & 0  & 0  \\
    0  & 0  & 0  & 1  & 0  \\
    0  & 0  & 0  & 0  & 1
  \end{bmatrix}_{8 \times 5}
  \begin{bmatrix}
    \hat{y}_{AA,t} \\
    \hat{y}_{AB,t} \\
    \hat{y}_{AC,t} \\
    \hat{y}_{BA,t} \\
    \hat{y}_{BB,t}
  \end{bmatrix}_{5 \times 1}
$$ {#eq-reconciliacao2}

\begin{center}
\scriptsize
\bf{\it{exemplo 1: matriz de soma}}
\end{center}

## MATRIZ DE RECONCILIAÇÃO

$\mathbfit{G}$ mapeia o nível mais desagregado a partir das previsões de todos os níveis da hierarquia, garantindo a coerência

$$
\begin{bmatrix}
    \tilde{y}_{t} \\
    \tilde{y}_{A, t} \\
    \tilde{y}_{B, t} \\
    \tilde{y}_{AA, t} \\
    \tilde{y}_{AB, t} \\
    \tilde{y}_{AC, t} \\
    \tilde{y}_{BA, t} \\
    \tilde{y}_{BB, t}
\end{bmatrix}_{8 \times 1}
=
\mathbfit{S}_{n \times m}
\begin{bmatrix}
    p_1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
    p_2 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
    p_3 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
    p_4 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
    p_5 & 0 & 0 & 0 & 0 & 0 & 0 & 0
\end{bmatrix}_{5 \times 8}
\begin{bmatrix}
    \hat{y}_{T+h|T} \\
    \hat{y}_{A, T+h|T} \\
    \hat{y}_{B, T+h|T} \\
    \hat{y}_{AA, T+h|T} \\
    \hat{y}_{AB, T+h|T} \\
    \hat{y}_{AC, T+h|T} \\
    \hat{y}_{BA, T+h|T} \\
    \hat{y}_{BB, T+h|T}
\end{bmatrix}_{8 \times 1}
$$ {#eq-reconciliacao3}

\begin{center}
\scriptsize
\bf{\it{exemplo 2: matriz de reconciliação} top-down}
\end{center}

## MATRIZ DE RECONCILIAÇÃO

$$
\begin{bmatrix}
    \tilde{y}_{t} \\
    \tilde{y}_{A, t} \\
    \tilde{y}_{B, t} \\
    \tilde{y}_{AA, t} \\
    \tilde{y}_{AB, t} \\
    \tilde{y}_{AC, t} \\
    \tilde{y}_{BA, t} \\
    \tilde{y}_{BB, t}
\end{bmatrix}_{8 \times 1}
=
\mathbfit{S}_{8 \times 5}
\begin{bmatrix}
    0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
    0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 \\
    0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
\end{bmatrix}_{5 \times 8}
\begin{bmatrix}
    \hat{y}_{T+h|T} \\
    \hat{y}_{A, T+h|T} \\
    \hat{y}_{B, T+h|T} \\
    \hat{y}_{AA, T+h|T} \\
    \hat{y}_{AB, T+h|T} \\
    \hat{y}_{AC, T+h|T} \\
    \hat{y}_{BA, T+h|T} \\
    \hat{y}_{BB, T+h|T}
\end{bmatrix}_{8 \times 1}
$$ {#eq-reconciliacao4}

\begin{center}
\scriptsize
\bf{\it{exemplo 3: matriz de reconciliação} bottom-up}
\end{center}

## MATRIZ DE RECONCILIAÇÃO

E se quisermos utilizar toda a informação e não apenas parte do espaço das previsões base?

### O PROBLEMA DE PESQUISA DA RECONCILIAÇÃO ÓTIMA

Estimar uma matriz de reconciliação $\mathbfit{G}$ que utilize toda a informação disponível e com o menor erro de previsão

## MATRIZ DE RECONCILIAÇÃO

### PROBLEMA DE REGRESSÃO

- Minimização do traço da matriz de covariância dos erros das previsões reconciliadas (MinT^[[@wickramasuriya_optimal_2019].])
$$
\min_{\tilde{e}} y_{T+h} - \tilde{y}_{T+h}
$$ {#eq-mint1}

- Mínimos Quadrados Generalizados (MQG)
$$
\mathbfit{G}=(\mathbfit{S}'\mathbfit{W}_h^{\dagger}\mathbfit{S})^{-1}\mathbfit{S}'\mathbfit{W}_h^{\dagger}
$$ {#eq-mint2}

Substituindo $\mathbfit{G}$ na [@eq-reconciliacao1], temos:

$$
\mathbfit{\tilde{y}}=\mathbfit{S}(\mathbfit{S}'\mathbfit{W}_h^{\dagger}\mathbfit{S})^{-1}\mathbfit{S}'\mathbfit{W}_h^{\dagger}\mathbfit{\hat{y}_{h}}
$$ {#eq-mint3}

## RECONCILIAÇÃO POR MACHINE LEARNING

![Abordagem de reconciliação ótima por ML. Fonte: @spiliotis_hierarchical_2021](img/spiliotis.png)

# METODOLOGIA

## DADOS E VARIÁVEIS

- Estatística Bancária Mensal e por Município (Bacen)
- Municípios (IBGE)
- Saldos de crédito dos verbetes empréstimos e financiamentos
- CNPJ Banestes mas expansível para todo SFN
- 01/2003 - 12/2022
- 37.920 observações (114.480 com nós de agregação)

## DADOS E VARIÁVEIS

- Estrutura hierárquica
    - total
    - 4 mesorregiões
    - 13 microrregiões
    - 79 agências
- Estrutura agrupada
    - 2 modalidades de crédito

## PREVISÕES BASE

- Previsões para fora da amostra a serem reconciliadas
- ETS (podem ser obtidas por qualquer método, incluindo ML)
- Treino: 01/2003 - 12/2021
- Horizonte de previsão ($h$): 01/2022 - 12/2022, fora da amostra

## DESIGN DO EXPERIMENTO

Dado um conjunto de previsões base, *o quanto mais precisas elas se tornam ao se aplicar um determinado método de reconciliação*?

## DESIGN DO EXPERIMENTO

Metodologia de @spiliotis_hierarchical_2021:

1. Previsões para dentro da amostra (ETS)
1. Treino dos modelos de ML para cada $y_m$
1. Reconciliação ótima das previsões base (fora da amostra)
1. Agregação das previsões reconciliadas para obtenção dos demais níveis hierárquicos

### METODOLOGIA ML VERSUS MINT

(i) a utilização de algoritmos de ML ao invés de MQG, (ii) a não atribuição de peso de forma obrigatória para todos os nós da hierarquia e (iii) no ajuste de um modelo individual para cada série do nível mais desagregado, permitindo maior especialização e sendo capaz de se adaptar melhor aos diferentes padrões de cada série [@spiliotis_hierarchical_2021].

## DESIGN DO EXPERIMENTO

- Métodos de reconciliação:
    - Analíticos: *Bottom-up* e MinT *Shrink*
    - Regressão regularizada: *Elastic Net* (lasso, ridge e CV)
    - Árvores: *Random forest*, XGBoost e LightGBM
    - *Support Vector Machines* (SVM)
- Estratégias para obtenção da amostra de treino:
    - *Rolling forecast*
    - *Reduced fitted base forecasts*
    - *Fitted base forecasts*

## ROLLING FORECAST

![Estratégia *Rolling Forecast*](img/modelagem_2.png){width=90%}

# REFERÊNCIAS

## BIBLIOGRAFIA
